<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>NDT Field Test — Offline Persistence Example</title>
		<!-- PICT Dynamic View CSS Container -->
		<style id="PICT-CSS"></style>
		<style>
			*, *::before, *::after { box-sizing: border-box; }
			body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #F0F4F8; color: #1A202C; }

			/* --- Header Bar --- */
			.app-header { display: flex; align-items: stretch; background: #1A365D; border-bottom: 3px solid #DD6B20; }
			.app-badge { background: #DD6B20; color: #fff; padding: 0.6rem 1rem; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; display: flex; align-items: center; gap: 0.5rem; }
			.app-badge svg { width: 14px; height: 14px; fill: #fff; flex-shrink: 0; }
			.app-title { padding: 0.6rem 1rem; color: #EBF8FF; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; }
			.app-module { margin-left: auto; padding: 0.6rem 1rem; color: #90CDF4; font-size: 0.75rem; display: flex; align-items: center; letter-spacing: 0.03em; }

			/* --- Layout --- */
			.app-layout { display: flex; gap: 0; min-height: calc(100vh - 42px); }

			/* --- Sidebar --- */
			.sidebar { width: 380px; min-width: 380px; background: #fff; border-right: 1px solid #CBD5E0; display: flex; flex-direction: column; overflow-y: auto; }
			.sidebar-section { padding: 1rem; border-bottom: 1px solid #E2E8F0; }
			.sidebar-section h3 { margin: 0 0 0.75rem 0; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; color: #718096; }
			.sidebar-section h4 { margin: 0.5rem 0 0.25rem 0; font-size: 0.75rem; color: #4A5568; }

			/* --- New Test Controls --- */
			.new-test-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
			.new-test-row select, .new-test-row input { flex: 1; padding: 0.4rem 0.5rem; border: 1px solid #CBD5E0; border-radius: 4px; font-size: 0.8rem; background: #fff; }
			.btn { padding: 0.4rem 0.75rem; border: none; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
			.btn-primary { background: #DD6B20; color: #fff; }
			.btn-primary:hover { background: #C05621; }
			.btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
			.btn-danger { background: #E53E3E; color: #fff; }
			.btn-danger:hover { background: #C53030; }
			.btn-success { background: #38A169; color: #fff; }
			.btn-success:hover { background: #2F855A; }
			.btn-outline { background: transparent; border: 1px solid #CBD5E0; color: #4A5568; }
			.btn-outline:hover { background: #EDF2F7; }

			/* --- Form List --- */
			.form-list { list-style: none; padding: 0; margin: 0; }
			.form-list-item { padding: 0.6rem 0.75rem; border: 1px solid #E2E8F0; border-radius: 4px; margin-bottom: 0.4rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; transition: background 0.15s; }
			.form-list-item:hover { background: #EBF8FF; }
			.form-list-item.active { background: #BEE3F8; border-color: #3182CE; }
			.form-list-item .label { flex: 1; font-weight: 500; }
			.form-list-item .meta { font-size: 0.7rem; color: #718096; }
			.form-list-item .badge-synced { background: #C6F6D5; color: #22543D; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.65rem; font-weight: 600; }
			.form-list-item .badge-dirty { background: #FED7D7; color: #822727; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.65rem; font-weight: 600; }
			.form-list-empty { font-size: 0.8rem; color: #A0AEC0; font-style: italic; padding: 0.5rem 0; }

			/* --- Data Inspector --- */
			.inspector { padding: 1rem; flex: 1; overflow-y: auto; }
			.inspector pre { background: #2D3748; color: #E2E8F0; padding: 0.75rem; border-radius: 4px; font-size: 0.7rem; overflow-x: auto; max-height: 250px; white-space: pre-wrap; word-break: break-all; }
			.inspector-tabs { display: flex; gap: 0; border-bottom: 2px solid #E2E8F0; margin-bottom: 0.75rem; }
			.inspector-tab { padding: 0.4rem 0.75rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; color: #718096; }
			.inspector-tab.active { color: #1A365D; border-bottom-color: #DD6B20; }
			.storage-stats { font-size: 0.75rem; color: #718096; margin-top: 0.5rem; }

			/* --- Main Content --- */
			.main-content { flex: 1; padding: 1.25rem; overflow-x: auto; }
			#Pict-Form-Container { background: #fff; border: 1px solid #CBD5E0; border-top: 4px solid #DD6B20; border-radius: 6px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(26,54,93,0.08); min-width: 800px; }

			/* --- Form Element Styling --- */
			#Pict-Form-Container input[type="text"],
			#Pict-Form-Container input[type="number"],
			#Pict-Form-Container input[type="date"],
			#Pict-Form-Container textarea,
			#Pict-Form-Container select { border: 1px solid #CBD5E0; background: #F7FAFC; padding: 0.45rem 0.6rem; border-radius: 4px; font-size: 0.85rem; color: #1A202C; width: 100%; }
			#Pict-Form-Container input:focus,
			#Pict-Form-Container textarea:focus,
			#Pict-Form-Container select:focus { outline: none; border-color: #DD6B20; box-shadow: 0 0 0 2px rgba(221,107,32,0.15); }
			#Pict-Form-Container label { color: #2D3748; font-weight: 600; font-size: 0.8rem; }
			#Pict-Form-Container h2 { color: #1A365D; font-size: 1.1rem; border-bottom: 2px solid #E2E8F0; padding-bottom: 0.4rem; }
			#Pict-Form-Container h3 { color: #2D3748; font-size: 0.95rem; }
			#Pict-Form-Container button,
			#Pict-Form-Container input[type="button"],
			#Pict-Form-Container input[type="submit"] { background: #DD6B20; color: #fff; border: none; padding: 0.5rem 1.25rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
			#Pict-Form-Container button:hover { background: #C05621; }
			#Pict-Form-Container table { width: 100%; border-collapse: collapse; }
			#Pict-Form-Container th { background: #1A365D; color: #EBF8FF; padding: 0.5rem 0.75rem; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.03em; }
			#Pict-Form-Container td { padding: 0.4rem 0.6rem; border-bottom: 1px solid #E2E8F0; font-size: 0.8rem; }
			#Pict-Form-Container tr:nth-child(even) td { background: #F7FAFC; }

			/* --- Status bar --- */
			.status-bar { background: #2D3748; color: #A0AEC0; padding: 0.35rem 1rem; font-size: 0.7rem; display: flex; align-items: center; gap: 1rem; }
			.status-bar .online { color: #68D391; }
			.status-bar .offline { color: #FC8181; }
			.status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.25rem; }
			.status-dot.online { background: #68D391; }
			.status-dot.offline { background: #FC8181; }
		</style>
		<script src="./pict.js" type="text/javascript"></script>
		<script src="./chart.umd.js"></script>
		<script type="text/javascript">
			// Wait for document ready, then load the Pict application
			Pict.safeOnDocumentReady(function ()
			{
				Pict.safeLoadPictApplication(NdtFieldTest, 0);
				// Give Pict a tick to initialize before refreshing the sidebar
				setTimeout(function () { refreshFormList(); refreshInspector(); }, 500);
			});

			// ======================================================================
			// Sidebar: Form Instance Management
			// ======================================================================

			function getFormPersistence()
			{
				return _Pict.providers.FormPersistence;
			}

			function refreshFormList()
			{
				var tmpPersistence = getFormPersistence();
				if (!tmpPersistence) return;

				var tmpRecords = tmpPersistence.listFormRecords();
				var tmpActiveGUID = tmpPersistence.getActiveFormGUID();
				var tmpContainer = document.getElementById('form-list');

				if (!tmpRecords || tmpRecords.length === 0)
				{
					tmpContainer.innerHTML = '<div class="form-list-empty">No saved test forms. Create one above.</div>';
					return;
				}

				// Sort by modified date descending
				tmpRecords.sort(function (a, b) { return (b.Modified || '').localeCompare(a.Modified || ''); });

				var tmpHTML = '';
				for (var i = 0; i < tmpRecords.length; i++)
				{
					var tmpR = tmpRecords[i];
					var tmpIsActive = (tmpR.GUID === tmpActiveGUID);
					var tmpDateStr = tmpR.Modified ? new Date(tmpR.Modified).toLocaleString() : 'never';
					var tmpSyncBadge = tmpR.Synced
						? '<span class="badge-synced">SYNCED</span>'
						: '<span class="badge-dirty">UNSYNCED</span>';

					tmpHTML += '<li class="form-list-item' + (tmpIsActive ? ' active' : '') + '" onclick="loadForm(\'' + tmpR.GUID + '\')">';
					tmpHTML += '<div class="label">' + (tmpR.Label || tmpR.GUID.substring(0, 8) + '...') + '</div>';
					tmpHTML += tmpSyncBadge;
					tmpHTML += '<div class="meta">' + tmpDateStr + '</div>';
					tmpHTML += '<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteForm(\'' + tmpR.GUID + '\');" title="Delete">&times;</button>';
					tmpHTML += '</li>';
				}
				tmpContainer.innerHTML = tmpHTML;
			}

			function createNewTest()
			{
				var tmpProjectSelect = document.getElementById('new-project');
				var tmpLabelInput = document.getElementById('new-label');
				var tmpProjectID = tmpProjectSelect.value;
				var tmpLabel = tmpLabelInput.value.trim();

				if (!tmpProjectID)
				{
					alert('Please select a project.');
					return;
				}
				if (!tmpLabel)
				{
					tmpLabel = 'Test ' + new Date().toLocaleTimeString();
				}

				_Pict.PictApplication.createNewTest(tmpProjectID, tmpLabel);
				tmpLabelInput.value = '';
				refreshFormList();
				refreshInspector();
			}

			function loadForm(pGUID)
			{
				_Pict.PictApplication.loadTest(pGUID);
				refreshFormList();
				refreshInspector();
			}

			function deleteForm(pGUID)
			{
				if (!confirm('Delete this test form? This cannot be undone.')) return;
				var tmpPersistence = getFormPersistence();
				if (tmpPersistence.getActiveFormGUID() === pGUID)
				{
					tmpPersistence.setActiveFormGUID(null);
				}
				tmpPersistence.deleteFormRecord(pGUID);
				refreshFormList();
				refreshInspector();
			}

			function saveCurrentForm()
			{
				var tmpPersistence = getFormPersistence();
				if (!tmpPersistence.getActiveFormGUID())
				{
					alert('No active form to save.');
					return;
				}
				tmpPersistence.persistActiveForm();
				refreshFormList();
				refreshInspector();
			}

			function simulateSync()
			{
				var tmpPersistence = getFormPersistence();
				var tmpUnsynced = tmpPersistence.listUnsyncedFormRecords();
				if (tmpUnsynced.length === 0)
				{
					alert('All forms are already synced!');
					return;
				}
				for (var i = 0; i < tmpUnsynced.length; i++)
				{
					// In a real app, we would POST getFormDataRaw() to the server here
					tmpPersistence.markFormSynced(tmpUnsynced[i].GUID);
				}
				alert('Synced ' + tmpUnsynced.length + ' form(s) to server (simulated).');
				refreshFormList();
				refreshInspector();
			}

			function clearAllData()
			{
				if (!confirm('Clear ALL offline form data? This cannot be undone.')) return;
				var tmpPersistence = getFormPersistence();
				var tmpRecords = tmpPersistence.listFormRecords();
				for (var i = 0; i < tmpRecords.length; i++)
				{
					tmpPersistence.deleteFormRecord(tmpRecords[i].GUID);
				}
				tmpPersistence.setActiveFormGUID(null);
				refreshFormList();
				refreshInspector();
			}

			// ======================================================================
			// Inspector Panel
			// ======================================================================

			var currentInspectorTab = 'index';

			function setInspectorTab(pTab)
			{
				currentInspectorTab = pTab;
				var tmpTabs = document.querySelectorAll('.inspector-tab');
				for (var i = 0; i < tmpTabs.length; i++)
				{
					tmpTabs[i].className = 'inspector-tab' + (tmpTabs[i].getAttribute('data-tab') === pTab ? ' active' : '');
				}
				refreshInspector();
			}

			function refreshInspector()
			{
				var tmpOutput = document.getElementById('inspector-output');
				var tmpStats = document.getElementById('storage-stats');
				if (!tmpOutput) return;

				var tmpPersistence = getFormPersistence();
				if (!tmpPersistence)
				{
					tmpOutput.textContent = 'FormPersistence provider not loaded yet.';
					return;
				}

				var tmpData = '';
				try
				{
					switch (currentInspectorTab)
					{
						case 'index':
							tmpData = JSON.stringify(tmpPersistence.getFormIndex(), null, 2);
							break;
						case 'formdata':
							var tmpGUID = tmpPersistence.getActiveFormGUID();
							if (tmpGUID)
							{
								var tmpRaw = tmpPersistence.getFormDataRaw(tmpGUID);
								tmpData = tmpRaw ? JSON.stringify(JSON.parse(tmpRaw), null, 2) : '(no data saved yet)';
							}
							else
							{
								tmpData = '(no active form selected)';
							}
							break;
						case 'bundle':
							tmpData = JSON.stringify(_Pict.Bundle, null, 2);
							break;
						case 'appdata':
							tmpData = JSON.stringify(_Pict.AppData, null, 2);
							break;
					}
				}
				catch (e)
				{
					tmpData = 'Error: ' + e.message;
				}

				tmpOutput.textContent = tmpData;

				// Storage stats
				if (tmpStats)
				{
					var tmpTotal = 0;
					try
					{
						for (var k in localStorage)
						{
							if (localStorage.hasOwnProperty(k) && k.startsWith('PSF:'))
							{
								tmpTotal += localStorage[k].length;
							}
						}
					}
					catch (e) { /* ignore */ }
					var tmpKB = (tmpTotal / 1024).toFixed(1);
					var tmpRecordCount = tmpPersistence.listFormRecords().length;
					var tmpUnsyncedCount = tmpPersistence.listUnsyncedFormRecords().length;
					tmpStats.innerHTML = 'Storage: <strong>' + tmpKB + ' KB</strong> &middot; Records: <strong>' + tmpRecordCount + '</strong> &middot; Unsynced: <strong>' + tmpUnsyncedCount + '</strong>';
				}
			}

			// Refresh inspector periodically to show autosave updates
			setInterval(function ()
			{
				refreshFormList();
				refreshInspector();
			}, 3000);
		</script>
	</head>
	<body>
		<!-- Header -->
		<div class="app-header">
			<div class="app-badge">
				<svg viewBox="0 0 16 16"><polygon points="8,1 10,6 16,6 11,9.5 13,15 8,11.5 3,15 5,9.5 0,6 6,6"/></svg>
				Pict Example
			</div>
			<div class="app-title">NDT Field Test — Offline Persistence</div>
			<div class="app-module">pict-section-form + FormPersistence</div>
		</div>

		<!-- Status Bar -->
		<div class="status-bar">
			<span><span class="status-dot" id="status-dot"></span><span id="status-text"></span></span>
			<span>Autosave: <strong>ON</strong> (1.5s debounce)</span>
			<span style="margin-left:auto;">
				<button class="btn btn-success btn-sm" onclick="simulateSync();">Sync All to Server</button>
				<button class="btn btn-outline btn-sm" onclick="refreshFormList(); refreshInspector();">Refresh</button>
			</span>
		</div>

		<!-- Main Layout: Sidebar + Content -->
		<div class="app-layout">
			<!-- Sidebar -->
			<div class="sidebar">
				<!-- New Test -->
				<div class="sidebar-section">
					<h3>New Test Form</h3>
					<div class="new-test-row">
						<select id="new-project">
							<option value="">Select project...</option>
							<option value="PRJ-001">I-40 Resurfacing</option>
							<option value="PRJ-002">US-550 Overlay</option>
							<option value="PRJ-003">NM-14 Reconstruction</option>
						</select>
					</div>
					<div class="new-test-row">
						<input type="text" id="new-label" placeholder="Test label (optional)" />
						<button class="btn btn-primary" onclick="createNewTest();">+ Create</button>
					</div>
				</div>

				<!-- Saved Forms -->
				<div class="sidebar-section" style="flex:1; overflow-y:auto;">
					<h3>Saved Test Forms</h3>
					<div id="form-list">
						<div class="form-list-empty">Loading...</div>
					</div>
					<div style="margin-top:0.75rem; display:flex; gap:0.5rem;">
						<button class="btn btn-outline btn-sm" onclick="saveCurrentForm();">Save Now</button>
						<button class="btn btn-danger btn-sm" onclick="clearAllData();">Clear All</button>
					</div>
				</div>

				<!-- Data Inspector -->
				<div class="sidebar-section inspector">
					<h3>Data Inspector</h3>
					<div class="inspector-tabs">
						<div class="inspector-tab active" data-tab="index" onclick="setInspectorTab('index');">Index</div>
						<div class="inspector-tab" data-tab="formdata" onclick="setInspectorTab('formdata');">Form Data</div>
						<div class="inspector-tab" data-tab="bundle" onclick="setInspectorTab('bundle');">Bundle</div>
						<div class="inspector-tab" data-tab="appdata" onclick="setInspectorTab('appdata');">AppData</div>
					</div>
					<pre id="inspector-output">Loading...</pre>
					<div class="storage-stats" id="storage-stats"></div>
				</div>
			</div>

			<!-- Main Form Content -->
			<div class="main-content">
				<div id="Pict-Form-Container"></div>
			</div>
		</div>

		<script src="./ndt_field_test.js" type="text/javascript"></script>
		<script>
			// Online/offline status detection
			function updateOnlineStatus()
			{
				var tmpDot = document.getElementById('status-dot');
				var tmpText = document.getElementById('status-text');
				if (navigator.onLine)
				{
					tmpDot.className = 'status-dot online';
					tmpText.className = 'online';
					tmpText.textContent = 'Online';
				}
				else
				{
					tmpDot.className = 'status-dot offline';
					tmpText.className = 'offline';
					tmpText.textContent = 'Offline';
				}
			}
			window.addEventListener('online', updateOnlineStatus);
			window.addEventListener('offline', updateOnlineStatus);
			updateOnlineStatus();
		</script>
	</body>
</html>
